#@TYPE: Machine
#@NAME: de10-nano-audio-mini
#@DESCRIPTION: Machine configuration for the DE10 Nano with Audio Mini SD Card Boot" 

# Include base SOCFPGA configuration and UBIFS filesystem support
require conf/machine/include/socfpga.inc
require conf/machine/include/ubifs.inc

# Setup Configuration
# Default deployment method - can be "sd" for SD card or "tftp-nfs" for network boot
DE10_NANO_DEPLOY_CONFIG ??= "sd"
# Combine machine name with deployment config to create unique configuration identifier
DE10_NANO_CONFIG ??= "${MACHINE}-${DE10_NANO_DEPLOY_CONFIG}"


CUSTOM_UBOOT_CONFIG ?= ""
CUSTOM_UBOOT_CONFIG_PATH ?= ""

# U-Boot Configuration
# Set the U-Boot configuration based on the deployment method
UBOOT_CONFIG ??= "${DE10_NANO_CONFIG}"
# U-Boot defconfig for SD card boot method
UBOOT_CONFIG[de10-nano-audio-mini-sd] = "de10_nano_audio_mini_sd_defconfig"
# U-Boot defconfig for TFTP/NFS network boot method
# UBOOT_CONFIG[de10-nano-audio-mini-tftp-nfs] = "socfpga_de10_nano_defconfig"
UBOOT_CONFIG[de10-nano-audio-mini-custom] = "${CUSTOM_UBOOT_CONFIG}"


# Kernel and bootloader preferences
# Use the SOCFPGA-specific long-term support kernel
PREFERRED_PROVIDER_virtual/kernel = "linux-socfpga-lts"
# Prefer kernel version 6.6.x (% allows any patch version)
PREFERRED_VERSION_linux-socfpga-lts = "6.6%"
# Use U-Boot as the bootloader
PREFERRED_PROVIDER_virtual/bootloader = "u-boot"

# System configuration
# Use systemd as the init system (alternative would be SysVinit)
INIT_MANAGER ?= "systemd"

# Kernel machine type for Cyclone V FPGA family
KMACHINE = "cyclone5"

# Device Tree Configuration
# Specify the device tree blob file for the DE10 Nano board
KERNEL_DEVICETREE ?= "\
			socfpga_cyclone5_de10_nano.dtb \
			"

# Serial Console Configuration
# Configure serial console at 115200 baud rate on ttyS0 (UART0)
SERIAL_CONSOLES ?= "115200;ttyS0"

# U-Boot ExtLinux Configuration
# Enable U-Boot ExtLinux support for boot menu
UBOOT_EXTLINUX ?= "1"
# Define available boot labels (menu entries)
UBOOT_EXTLINUX_LABELS ?= "default"
# Set the default boot label name
UBOOT_EXTLINUX_DEFAULT_LABEL ?= "Cyclone5 SOCDK SDMMC"

# Console configuration for kernel command line
UBOOT_EXTLINUX_CONSOLE ?= "console=ttyS0,115200n8"
# Root filesystem location (partition 2 on SD card)
UBOOT_EXTLINUX_ROOT:default ?= "root=/dev/mmcblk0p2"
# Human-readable description for the boot menu
UBOOT_EXTLINUX_MENU_DESCRIPTION:default ?= "Cyclone5 SOCDK SDMMC"

# Path to kernel image relative to boot partition
UBOOT_EXTLINUX_KERNEL_IMAGE:default ?= "../${KERNEL_IMAGETYPE}"

# Directory containing device tree files
UBOOT_EXTLINUX_FDTDIR:default ?= "../intel/socfpga/"
# Additional kernel command line arguments
UBOOT_EXTLINUX_KERNEL_ARGS:default ?= "rootwait rw earlyprintk"

# JFFS2 Filesystem Configuration
# Set erase block size for JFFS2 to 64KB (0x10000)
EXTRA_IMAGECMD:jffs2 ?= "-e 0x10000"

# Boot Partition Files Configuration
# Define files to include in the boot partition of the SD card image
IMAGE_BOOT_FILES ?= "\
	socfpga_cyclone5_de10_nano.dtb;intel/socfpga/socfpga_cyclone5_de10_nano.dtb \
	${KERNEL_IMAGETYPE} \
	extlinux.conf;extlinux/extlinux.conf \
	"

# Image Generation Configuration
# Use the Cyclone5/Arria5 WIC kickstart file for SD card image layout
WKS_FILE ?= "sdimage-cyclone5-arria5.wks"
# Add WIC (OpenEmbedded Image Creator) format to generated image types
IMAGE_FSTYPES:append = " wic"

# Package Management Configuration
# Add APT and DPKG package managers to the root filesystem
IMAGE_INSTALL:append = " apt dpkg "
# Add Debian package feed URI for additional packages
PACKAGE_FEED_URIS:append = " http://mirror.0x.sg/debian/"
# Set base path for package feeds (RPM format)
PACKAGE_FEED_BASE_PATHS:append = " rpm"
# Define supported architectures for package feeds
PACKAGE_FEED_ARCHS:append = " all armhf"

# Use Debian package format (.deb) for package management
PACKAGE_CLASSES ?= "package_deb"

# Additional Image Features
# Enable development and debugging features in the image
EXTRA_IMAGE_FEATURES ?= "debug-tweaks tools-sdk tools-debug package-management"
